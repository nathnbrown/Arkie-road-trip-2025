<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Location Map</title>
    
    <!-- Leaflet.js CSS for map styling -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

    <!-- Leaflet.markercluster plugin CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <!-- PapaParse library for parsing CSV data -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        /* Basic styling for the page */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f0f2f5;
        }

        /* Header styling */
        .header {
            background-color: #ffffff;
            padding: 1rem 2rem;
            border-bottom: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            z-index: 1001; /* Ensure header is above other elements */
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            color: #333;
        }

        /* Status message styling */
        .status-message {
            padding: 0.75rem 2rem;
            background-color: #fffbe6;
            color: #8a6d3b;
            text-align: center;
            font-size: 0.9rem;
            display: none; /* Hidden by default */
            border-bottom: 1px solid #ffeeba;
        }

        /* Map container styling */
        #map {
            height: 100%; /* Take remaining height */
            width: 100%;
        }
        
        /* Custom popup styling for a modern look */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .leaflet-popup-content {
            margin: 15px;
            font-size: 14px;
            line-height: 1.6;
        }
        .leaflet-popup-content h3 {
            margin: 0 0 10px;
            font-size: 16px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .leaflet-popup-content p {
            margin: 5px 0;
        }
        .leaflet-popup-tip-container {
            width: 40px;
            height: 20px;
        }
        .navigate-button {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 12px;
            background-color: #007bff;
            color: #ffffff;
            text-align: center;
            text-decoration: none;
            border-radius: 5px;
            font-weight: 500;
        }

        /* Modal styling for permissions error */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        .modal-content h3 {
            margin-top: 0;
            color: #333;
        }
        .modal-content p {
            color: #555;
        }
        .modal-content button {
            margin-top: 1rem;
            padding: 10px 20px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .modal-content button:hover {
            background-color: #0056b3;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>

    <div class="header">
        <h1>Atlas Arkansas</h1>
    </div>
    
    <div id="status-message" class="status-message"></div>

    <div id="map"></div>

    <!-- Modal for explaining permissions policy error -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h3>Geolocation Disabled</h3>
            <p>This interactive preview has geolocation disabled by its security policy. This is a feature of the environment, not a bug in the code.</p>
            <p>The user location feature will work correctly when you publish this file on your live website.</p>
            <button id="modal-close-button">Understood</button>
        </div>
    </div>

    <!-- Leaflet.js JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
     
    <!-- Leaflet.markercluster plugin JavaScript -->
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        const statusMessage = document.getElementById('status-message');
        const modalOverlay = document.getElementById('modal-overlay');
        const modalCloseButton = document.getElementById('modal-close-button');
        let userLat = null;
        let userLng = null;

        // --- BASEMAPS ---
        const streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        });

        const topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        	maxZoom: 17,
        	attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
        });
        
        const dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        	attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        	subdomains: 'abcd',
        	maxZoom: 19
        });

        const baseMaps = {
            "Streets": streets,
            "Topographic": topo,
            "Dark": dark
        };

        // --- MAP INITIALIZATION ---
        const map = L.map('map', {
            layers: [streets] // Set default layer
        }).setView([34.7465, -92.2896], 13);

        L.control.layers(baseMaps).addTo(map);

        // --- GEOLOCATION ---
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLat = position.coords.latitude;
                    userLng = position.coords.longitude;

                    const userIcon = L.icon({
                        iconUrl: 'https://placehold.co/32x32/3498db/ffffff?text=YOU',
                        iconSize: [32, 32],
                        iconAnchor: [16, 32],
                        popupAnchor: [0, -32]
                    });

                    L.marker([userLat, userLng], { icon: userIcon }).addTo(map)
                        .bindPopup("<b>You are here!</b>").openPopup();
                    map.setView([userLat, userLng], 14);
                },
                (error) => {
                    // Handle geolocation errors with more specific user feedback.
                    console.error(`Error getting user location (Code: ${error.code}): ${error.message}`);
                    let userMessage = "Could not retrieve your location. ";
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            if (error.message && error.message.toLowerCase().includes("permissions policy")) {
                                modalOverlay.style.display = 'flex';
                            } else {
                                userMessage += "Please enable location permissions in your browser to see your position.";
                                statusMessage.textContent = userMessage;
                                statusMessage.style.display = 'block';
                            }
                            break;
                        case error.POSITION_UNAVAILABLE:
                            userMessage += "Location information is currently unavailable.";
                            statusMessage.textContent = userMessage;
                            statusMessage.style.display = 'block';
                            break;
                        case error.TIMEOUT:
                            userMessage += "The request to get your location timed out.";
                            statusMessage.textContent = userMessage;
                            statusMessage.style.display = 'block';
                            break;
                        default:
                            userMessage += "An unknown error occurred.";
                            statusMessage.textContent = userMessage;
                            statusMessage.style.display = 'block';
                            break;
                    }
                }
            );
        } else {
            statusMessage.textContent = "Geolocation is not supported by this browser.";
            statusMessage.style.display = 'block';
        }

        // --- MODAL CLOSE ---
        modalCloseButton.addEventListener('click', () => {
            modalOverlay.style.display = 'none';
        });

        // --- ICONS ---
        function getCategoryIcon(category) {
            const iconDetails = {
                'District': { color: '4a90e2', text: 'D' },
                'Park': { color: '7ed321', text: 'P' },
                'Landmark': { color: 'f5a623', text: 'L' },
                'Government': { color: '9b9b9b', text: 'G' },
                'Historic Site': { color: '8b572a', text: 'H' },
                'Museum': { color: 'bd10e0', text: 'M' },
                'Default': { color: '4a4a4a', text: '•' }
            };
            const details = iconDetails[category] || iconDetails['Default'];
            return L.icon({
                iconUrl: `https://placehold.co/38x38/${details.color}/ffffff?text=${details.text}&font=roboto`,
                iconSize: [38, 38],
                iconAnchor: [19, 38],
                popupAnchor: [0, -38]
            });
        }

       
    // --- PARSE AND PLOT CSV DATA ---
const markers = L.markerClusterGroup();

Papa.parse("locations.csv", { // <-- Change "locations.csv" to your file's name
    download: true, // This is the important part that fetches the file
    header: true,
    dynamicTyping: true,
    skipEmptyLines: true,
    complete: function(results) {
        plotData(results.data);
    }
});

        function plotData(data) {
            data.forEach(location => {
                if (location.Latitude && location.Longitude) {
                    const marker = L.marker([location.Latitude, location.Longitude], {
                        icon: getCategoryIcon(location.Category)
                    });

                    // --- Navigation Link ---
                    let navLink;
                    if (userLat && userLng) {
                        // If user location is available, create a directions link
                        navLink = `https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLng}&destination=${location.Latitude},${location.Longitude}`;
                    } else {
                        // Otherwise, just link to the location on the map
                        navLink = `https://www.google.com/maps/search/?api=1&query=${location.Latitude},${location.Longitude}`;
                    }

                    const popupContent = `
                        <h3>${location['Place Name']}</h3>
                        <p><strong>Category:</strong> ${location.Category}</p>
                        <p>${location.Description}</p>
                        <a href="${navLink}" target="_blank" class="navigate-button">Navigate There</a>
                    `;

                    marker.bindPopup(popupContent);
                    markers.addLayer(marker);
                }
            });
            map.addLayer(markers);
        }
    </script>
</body>
</html>
